<html>
	<head>
		<meta charset="UTF-8">
		<title>wechat js api test - general - weAPI</title>
		<meta http-equiv="pragma" content="no-cache" />
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,minimal-ui" name="viewport" />
		<script src="debug.js"></script>
		<script src="weAPI.js"></script>
		<style type="text/css">
			body{
				font-size: 20px;
			}
		</style>
	</head>
	<body>
		<a onclick="location.search='?'+(+new Date())">reload</a>
		<br>
		<a href="http://touch.qunar.com/">测试一下传说的链接跳转分享地址不对的bug</a>
	</body>
	<script>
	 	function _log(msg) {
	 		alert(msg)
	 	}
		weAPI.ready(function() {
			// for ios wechat v>=6.0
			weAPI.addPlugin({
				key: "generalShare",
				shareAction: true,
				dataFormater: function(data, shareTo) {
					// 由于是引用，因此避免直接写原对象
					var newData = {
						"appid":"",
			            "img_url":"",
			            "link":"",
			            "desc":"",
			            "title":"",
			            "img_width":"640",
			            "img_height":"640"
					}
					for(var i in data) {
						newData[i] = data[i]
					}
					if(shareTo == 'timeline') {
		                var title = newData.title;
		                newData.title = newData.desc || title;
		                newData.desc = title;
		            }
		            return newData
				}

			})
			var list = [
				[
					"shareTimeline", "朋友圈",
					{
						title:"shareTimeline",
						img_url: "http://file5.u148.net/2014/10/images/1412934017UEH.jpg",
						link: "http://file5.u148.net/2014/10/images/1412934017UEH.jpg"
					}
				],
				[
					"sendAppMessage",
					"微信好友",
					{
						title:"sendAppMessage",
						img_url: "http://file5.u148.net/2014/10/images/1412934017UEH.jpg",
						link: "http://file5.u148.net/2014/10/images/1412934017UEH.jpg"
					}
				],
				[
					"shareWeibo",
					"微博",
					{
						content: "shareWeibo",
						url: "http://qunar.com/"
					}
				]
			]
			var name = "hehe"
			weAPI.generalShare(list[0][2]).ready(function(data, argv) {
				_log(name + "ready")
				if(argv) {
					name = argv.shareTo
					var o = list[0][2]
					switch(argv.shareTo) {
						// case "shareTimeline":break;
						case "sendAppMessage": o = list[1][2];break;
						case "shareWeibo": o = list[2][2];break;
					}
					for(var i in o) {
						data[i] = o[i]
					}
				}
			}).cancel(function() {
				_log(name + "cancle")
			}).success(function() {
				_log(name + "success")
			}).fail(function() {
				_log(name + "fail")
			}).done(function(r) {
				_log(name + "done" + (r ? "-" + JSON.stringify(r) : ""))
			})
 		})
	</script>
</html>
